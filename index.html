<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠµê´€ íŠ¸ë˜ì»¤</title>
    <style>
        /* ë³€ìˆ˜ ì„¤ì • */
        :root {
            --accent-color: #e91e63;
            --light-accent-color: #ff80ab; 
            --very-light-color: #f8bbd0;
            --hover-color: #fce4ec;
            --separator-color: #f0f0f0; 
            --widget-background: rgba(255, 255, 255, 0.9);
            --text-color: #333;
        }

        /* ì´ˆê¸°í™” */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
        }

        /* ì „ì²´ ë°°ê²½ ë° ì¤‘ì•™ ì •ë ¬ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
        }

        /* ì»¨í…Œì´ë„ˆ (ìœ„ì ¯ ë³¸ì²´) */
        .container {
            background: var(--widget-background);
            border-radius: 18px;
            padding: 15px;
            width: 100%;
            max-width: 280px;
            box-shadow: none; 
            /* 1. **ìˆ˜ì •:** ì‚¬ê°í˜• ì™¸ê³½ì„  ì œê±° */
            border: none;
            position: relative;
        }

        /* ìŠµê´€ ëª©ë¡ ìƒë‹¨ (ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ) */
        .today-header {
            font-size: 12px;
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 10px;
            font-weight: 600;
            cursor: default; 
            padding: 5px;
            border-radius: 6px;
        }
        
        /* 2. **ìˆ˜ì •:** ìŠµê´€ ëª©ë¡ ìµœì†Œ ë†’ì´ ì„¤ì • (ë¹ˆ ìƒíƒœì—ì„œ ê³µê°„ ìœ ì§€) */
        #habitList {
            min-height: 80px; /* ì•½ 3~4ê°œì˜ ìŠµê´€ì´ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ë†’ì´ */
        }
        
        /* ìŠµê´€ í•­ëª© */
        .habit-item {
            display: flex;
            align-items: center;
            justify-content: space-between; 
            padding: 4px 0; 
            background: transparent;
            border-radius: 8px;
            margin-bottom: 0;
            transition: all 0.3s ease;
            
            border-bottom: 1px solid var(--separator-color);
            
            padding-left: 8px; 
            padding-right: 8px; 
            margin-left: -8px; 
            margin-right: -8px;
            
            cursor: grab; /* 3. ë“œë˜ê·¸ ê°€ëŠ¥í•¨ì„ ì‹œê°ì ìœ¼ë¡œ í‘œì‹œ */
        }
        .habit-item:active {
             cursor: grabbing;
        }
        
        .habit-item:hover { 
            background: var(--hover-color);
        }
        .habit-item.not-due { 
            opacity: 0.5; 
            pointer-events: none;
        }

        /* 3. **ì¶”ê°€:** ë“œë˜ê·¸ ì•¤ ë“œë¡­ CSS */
        .habit-item.dragging {
            opacity: 0.5;
            transform: scale(0.98);
            border: 2px dashed var(--accent-color);
            padding: 2px 8px; 
            background: var(--hover-color);
        }
        .habit-item.drag-over {
            box-shadow: 0 4px 0 -2px var(--accent-color) inset; /* ë“œë¡­ ì¡´ ì‹œê°ì  í‘œì‹œ */
        }

        /* ì²´í¬ í‘œì‹œ ë””ìì¸ */
        .checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid var(--accent-color); 
            border-radius: 50%;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: white; 
            margin-right: 8px; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .checkbox:hover { transform: scale(1.1); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .checkbox.checked { background: var(--accent-color); border-color: var(--accent-color); transform: scale(1.05); }
        .checkbox.checked::after {
            content: ''; width: 3px; height: 7px; border: solid white;
            border-width: 0 2px 2px 0; transform: rotate(45deg) translate(-1px, 0px); 
            display: block; margin-top: -1px;
        }
        
        .habit-editable-area { display: flex; align-items: center; flex: 1; padding: 4px 0; cursor: pointer; min-width: 0; }
        .habit-info { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; }
        .habit-name-group { display: flex; flex-direction: column; gap: 2px; flex: 1; min-width: 0; }

        .habit-name { 
            font-size: 11px; color: var(--text-color); font-weight: 600;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; letter-spacing: -0.01em; 
        }
        .habit-frequency { font-size: 9px; color: #999; }

        /* ì‚­ì œ ë²„íŠ¼ */
        .delete-btn { background: transparent; color: rgba(255, 0, 0, 0.4); border: none; font-size: 12px; cursor: pointer; transition: color 0.2s, opacity 0.3s; padding: 4px; line-height: 1; opacity: 0; z-index: 1; flex-shrink: 0; margin-left: 5px; }
        .habit-item:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: var(--accent-color); }
        
        /* ì§„í–‰ë¥  ì„¹ì…˜ ë””ìì¸ */
        .progress-section { margin-top: 10px; padding-top: 0px; border-top: none; display: flex; flex-direction: column; align-items: center; padding-bottom: 5px; }
        .progress-text { font-size: 10px; color: #999; font-weight: 500; margin-bottom: 4px; }
        .progress-bar-container { height: 10px; background-color: transparent; border-radius: 5px; overflow: hidden; width: 100%; border: 1px solid var(--very-light-color); }
        .progress-bar { height: 100%; width: 0%; background: var(--accent-color); transition: width 0.5s ease-out; border-radius: 5px; }
        
        /* ì„¤ì • ë²„íŠ¼ ì˜ì—­ */
        .settings-btn-area { text-align: right; margin-top: 8px; padding-top: 5px; border-top: 1px solid var(--very-light-color); display: flex; justify-content: flex-end; gap: 2px; }
        .action-btn { background: transparent; color: var(--light-accent-color); padding: 0; font-size: 18px; border-radius: 50%; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: all 0.2s; }
        .action-btn:hover { color: var(--accent-color); background: var(--hover-color); }
        
        /* ìƒ‰ìƒ ì„ íƒ ë²„íŠ¼ */
        #colorIcon { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 1px var(--very-light-color); pointer-events: none; }
        .color-change-btn { padding: 8px; position: relative; }
        .color-change-btn input[type="color"] { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            opacity: 0; cursor: pointer; z-index: 100;
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ìƒëµ) */
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); border-radius: 18px; display: none; flex-direction: column; padding: 15px; z-index: 10; }
        .modal.open { display: flex; }
        .modal-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .modal-title { font-size: 14px; color: var(--accent-color); font-weight: 600; }
        .close-btn { background: transparent; border: none; color: var(--text-color); font-size: 18px; cursor: pointer; padding: 0; line-height: 1; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        #habitFormModal .modal-content { flex-grow: 1; overflow-y: auto; padding-bottom: 10px; }
        .modal-setting-group { margin-bottom: 12px; padding: 8px 10px; border: 1px solid var(--very-light-color); border-radius: 10px; }
        .modal-setting-group label { font-size: 10px; font-weight: 600; color: var(--text-color); padding-left: 5px; display: block; }
        #habitFormModal input[type="text"], #habitFormModal select, #habitFormModal input[type="number"] { width: 100%; padding: 6px; border: 1px solid var(--very-light-color); border-radius: 8px; font-size: 9px; outline: none; margin-top: 4px; }
        #habitFormModal input[type="number"] { width: 40px; text-align: center; }
        #habitFormModal .input-frequency { display: flex; align-items: center; gap: 5px; font-size: 10px; margin-top: 8px; }
        .day-selection-group { display: flex; justify-content: space-between; gap: 4px; margin-top: 8px; }
        .day-selection-group button { flex: 1; padding: 6px 4px; background: white; color: var(--text-color); border: 1px solid var(--very-light-color); border-radius: 8px; font-size: 9px; cursor: pointer; transition: all 0.2s; }
        .day-selection-group button.selected { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .day-selection-group button[data-day="6"]:not(.selected) { color: #007bff; }
        .day-selection-group button[data-day="0"]:not(.selected) { color: #dc3545; }
        #saveHabitBtn { width: 100%; padding: 8px; background: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 11px; font-weight: bold; cursor: pointer; transition: background 0.2s; margin-top: 10px; position: sticky; bottom: 0px; z-index: 11; box-shadow: 0 -4px 8px rgba(255, 255, 255, 0.9); }
        #saveHabitBtn:hover { background: var(--light-accent-color); }
        .confirm-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); padding: 15px; z-index: 20; text-align: center; border: 1px solid var(--very-light-color); display: none; }
        .confirm-modal-message { font-size: 11px; color: var(--text-color); margin-bottom: 12px; }
        .confirm-modal-buttons button { background: var(--accent-color); color: white; border: none; border-radius: 6px; padding: 5px 10px; font-size: 10px; cursor: pointer; margin: 0 4px; transition: background 0.2s; }
        .confirm-modal-buttons .confirm-yes:hover { background: var(--light-accent-color); }
        .confirm-modal-buttons .confirm-no { background: #ccc; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <div class="today-header" id="todayDateHeader"></div>
        <div id="habitList"></div>
        <div class="progress-section">
             <div class="progress-text" id="progressText">0/0</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
        <div class="settings-btn-area">
            <button class="action-btn add-habit-btn" onclick="openAddHabitModal()" title="ìƒˆ ìŠµê´€ ì¶”ê°€">+</button>
            <button class="action-btn color-change-btn" id="colorChangeBtn" title="ê°•ì¡° ìƒ‰ìƒ ë³€ê²½">
                <span id="colorIcon"></span>
                <input type="color" id="colorPicker" value="#e91e63">
            </button>
        </div>
        <div id="habitFormModal" class="modal"> 
            <div class="modal-header">
                <span class="modal-title" id="habitFormTitle">ìƒˆ ìŠµê´€ ì¶”ê°€</span>
                <button class="close-btn" onclick="closeHabitFormModal()">âœ•</button>
            </div>
            <div class="modal-content">
                <div class="modal-setting-group">
                    <label class="modal-setting-label">ìŠµê´€ ì´ë¦„</label>
                    <input type="text" id="habitNameInput" placeholder="ìŠµê´€ ì´ë¦„ ì…ë ¥"> 
                </div>
                <div class="modal-setting-group">
                    <label class="modal-setting-label">ë°˜ë³µ ì£¼ê¸° ì„¤ì •</label>
                    <select id="frequencySelect" onchange="toggleFrequencyOptions()"> 
                        <option value="daily">ë§¤ì¼ ë°˜ë³µ</option>
                        <option value="weekly_days">ì£¼ê°„ íŠ¹ì • ìš”ì¼ ë°˜ë³µ</option>
                        <option value="weekly_count">ì£¼ê°„ ì´ íšŸìˆ˜ ë°˜ë³µ</option>
                    </select>
                    <div id="daySelector" class="day-selection-group" style="display: none;">
                        <button data-day="1">ì›”</button>
                        <button data-day="2">í™”</button>
                        <button data-day="3">ìˆ˜</button>
                        <button data-day="4">ëª©</button>
                        <button data-day="5">ê¸ˆ</button>
                        <button data-day="6">í† </button>
                        <button data-day="0">ì¼</button>
                    </div>
                    <div id="countSelector" class="input-frequency" style="display: none;">
                        <label for="weeklyCountInput">ì£¼ ëª‡ íšŒ:</label>
                        <input type="number" id="weeklyCountInput" min="1" max="7" value="3">
                        <label>íšŒ</label>
                    </div>
                </div>
                <button id="saveHabitBtn" onclick="saveHabit()">ì €ì¥</button>
            </div>
        </div>
        <div id="confirmModal" class="confirm-modal">
            <div class="confirm-modal-message" id="confirmMessage"></div>
            <div class="confirm-modal-buttons">
                <button class="confirm-yes" id="confirmYesBtn">í™•ì¸</button>
                <button class="confirm-no" onclick="closeConfirmModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <script>
        // =========================================================================
        // ğŸ”¥ 2. FIREBASE ì„¤ì • ë° ì´ˆê¸°í™” (ë§¨ ìœ„ì— ìœ„ì¹˜í•´ì•¼ í•¨) ğŸ”¥
        // =========================================================================

        // âš ï¸ **í•„ìˆ˜:** ì´ ê°ì²´ì˜ ê°’ë“¤ì„ Firebase Consoleì—ì„œ ë³µì‚¬í•œ ì‹¤ì œ ê°’ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”.
        
       const firebaseConfig = {
  apiKey: "AIzaSyCtoccKZ-bfRPDi3lv8S5eIMJ8BHeI3YKQ",
  authDomain: "habit-tracker-widget.firebaseapp.com",
  projectId: "habit-tracker-widget",
  storageBucket: "habit-tracker-widget.firebasestorage.app",
  messagingSenderId: "1063108925492",
  appId: "1:1063108925492:web:5d1881cc0b2e1d04921261"
};
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let habitsRef; // ì‚¬ìš©ì UID ì„¤ì • í›„ í• ë‹¹ë  Realtime DB ì°¸ì¡°
        let historyRef; // ì‚¬ìš©ì UID ì„¤ì • í›„ í• ë‹¹ë  Realtime DB ì°¸ì¡°
        
        // =========================================================================
        // 3. ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™” (Local Storage ì‚¬ìš© ì œê±°)
        // =========================================================================
        const DEFAULT_HABITS = [];
        let habits = []; // Firebase ë¡œë“œ ëŒ€ê¸°
        let nextId = 1; // ID ê³„ì‚°ìš©
        let history = {}; // Firebase ë¡œë“œ ëŒ€ê¸°
        let currentHabitId = null;
        
        const TODAY_KEY = getTodayKey(); 
        const TODAY_DAY = new Date().getDay();

        // âš ï¸ ê¸°ì¡´ì˜ saveState() í•¨ìˆ˜ëŠ” ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.
        
        // =========================================================================
        // 4. í—¬í¼ í•¨ìˆ˜ ë° ìƒ‰ìƒ ë¡œì§ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€ ë° Local Storage ì œê±°)
        // =========================================================================
        
        function getTodayKey() { 
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`; 
        }
        function getStartOfWeek(date) { 
            const d = new Date(date);
            const day = d.getDay(); 
            const diff = d.getDate() - day; 
            d.setDate(diff); 
            d.setHours(0, 0, 0, 0); 
            return d;
        }

        const hexToHsl = (H) => { 
            var r = 0, g = 0, b = 0;
            if (H.length == 4) {
                r = parseInt(H[1]+H[1], 16); g = parseInt(H[2]+H[2], 16); b = parseInt(H[3]+H[3], 16);
            } else if (H.length == 7) {
                r = parseInt(H[1]+H[2], 16); g = parseInt(H[3]+H[4], 16); b = parseInt(H[5]+H[6], 16);
            }
            r /= 255; g /= 255; b /= 255;
            var max = Math.max(r, g, b), min = Math.min(r, g, b);
            var h, s, l = (max + min) / 2;
            if (max == min) { h = s = 0; } 
            else { 
                var d = max - min; 
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) { 
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break; 
                } 
                h /= 6;
            } 
            return [h * 360, s * 100, l * 100]; 
        };
        const hslToHex = (h, s, l) => { 
            h /= 360; s /= 100; l /= 100;
            var r, g, b; 
            if (s == 0) { r = g = b = l; } 
            else { 
                var hue2rgb = function hue2rgb(p, q, t) {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p; 
                };
                var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                var p = 2 * l - q; 
                r = hue2rgb(p, q, h + 1/3); g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3); 
            } 
            var toHex = function(c) { 
                var hex = Math.round(c * 255).toString(16);
                return hex.length == 1 ? "0" + hex : hex; 
            }; 
            return "#" + toHex(r) + toHex(g) + toHex(b); 
        };
        
        function updateColorIcon(color) { 
            const colorIcon = document.getElementById('colorIcon'); 
            if (colorIcon) colorIcon.style.backgroundColor = color;
        }
        
        function changeAccentColor(newColor) { 
            const [h, s, l] = hexToHsl(newColor);
            const lightAccent = hslToHex(h, s, Math.min(100, l + 20)); 
            const veryLightColor = hslToHex(h, s, Math.min(100, l + 45));
            const hoverColor = hslToHex(h, s, Math.min(100, l + 50)); 
            const separatorColor = hslToHex(h, s, 95); 
            document.documentElement.style.setProperty('--accent-color', newColor); 
            document.documentElement.style.setProperty('--light-accent-color', lightAccent);
            document.documentElement.style.setProperty('--very-light-color', veryLightColor); 
            document.documentElement.style.setProperty('--hover-color', hoverColor); 
            document.documentElement.style.setProperty('--separator-color', separatorColor); 
            // âš ï¸ Local Storage ì œê±°: localStorage.setItem('accentColor', newColor); 
            updateColorIcon(newColor); 
            renderHabits();
        }

        function isHabitDueToday(habit) { 
            if (habit.frequency === 'daily') return true;
            if (habit.frequency === 'weekly_days') return habit.days && habit.days.includes(TODAY_DAY); 
            if (habit.frequency === 'weekly_count') return true; 
            return false;
        }
        function getWeeklyCountProgress(habitId, targetCount) { 
            const startOfWeek = getStartOfWeek(new Date());
            let current = new Date(startOfWeek); 
            let checkedCount = 0; 
            const today = new Date();
            while (current <= today) { 
                const dateKey = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')}`; 
                if (history[dateKey] && history[dateKey][habitId]) checkedCount++;
                current.setDate(current.getDate() + 1); 
            } 
            return `[${checkedCount}/${targetCount}íšŒ ëª©í‘œ]`; 
        }
        function getFrequencyText(habit) { 
            if (habit.frequency === 'daily') return '[ë§¤ì¼]';
            if (habit.frequency === 'weekly_days' && habit.days && habit.days.length > 0) { 
                const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                const sortedDays = habit.days.sort((a, b) => { 
                    const normalizedA = a === 0 ? 7 : a; 
                    const normalizedB = b === 0 ? 7 : b; 
                    return normalizedA - normalizedB; 
                }).map(d => dayNames[d]);
                return `[ì£¼ ${habit.days.length}íšŒ: ${sortedDays.join(', ')}]`; 
            } 
            if (habit.frequency === 'weekly_count') return getWeeklyCountProgress(habit.id, habit.count); 
            return '[ì£¼ê¸° ë¯¸ì„¤ì •]';
        }
        
        // =========================================================================
        // ğŸ”¥ 5. FIREBASE ì¸ì¦ ë° ë™ê¸°í™” ë¡œì§ (ìƒˆë¡œ ì¶”ê°€) ğŸ”¥
        // =========================================================================

        // ë°ì´í„° ì €ì¥ í•¨ìˆ˜ (Local Storage ëŒ€ì²´)
        function saveHabitsToFirebase() {
            if (habitsRef) {
                habitsRef.set(habits)
                    .then(() => console.log("Habits saved to Firebase."))
                    .catch(error => console.error("Habits save error:", error));
            }
        }

        function saveHistoryToFirebase() {
            if (historyRef) {
                historyRef.set(history)
                    .then(() => console.log("History saved to Firebase."))
                    .catch(error => console.error("History save error:", error));
            }
        }
        
        // Realtime Databaseì—ì„œ ë°ì´í„° ë³€í™”ë¥¼ ê°ì§€í•˜ê³  ë™ê¸°í™”í•˜ëŠ” í•¨ìˆ˜
        function setupFirebaseListeners() {
            // 1. ìŠµê´€ ëª©ë¡(habits) ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            habitsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                habits = data ? data : DEFAULT_HABITS; 
                nextId = habits.length > 0 ? Math.max(...habits.map(h => h.id)) + 1 : 1;
                renderHabits(); // ë°ì´í„° ë³€ê²½ ì‹œ ë Œë”ë§
            }, (error) => {
                console.error("Habits listener error:", error);
            });

            // 2. ê¸°ë¡ íˆìŠ¤í† ë¦¬(history) ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            historyRef.on('value', (snapshot) => {
                const data = snapshot.val();
                history = data ? data : {}; 
                renderHabits(); // ê¸°ë¡ ë³€ê²½ ì‹œ ë Œë”ë§
            }, (error) => {
                console.error("History listener error:", error);
            });
        }

        // Firebase ìµëª… ë¡œê·¸ì¸ ë° ë°ì´í„° ì´ˆê¸°í™” í•¨ìˆ˜
        function initFirebaseApp() {
            firebase.auth().signInAnonymously()
                .then((userCredential) => {
                    const user = userCredential.user;
                    const userId = user.uid;
                    
                    console.log("Firebase initialized for user:", userId);
                    
                    // ì‚¬ìš©ì IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ê²½ë¡œ(Reference) ì„¤ì •
                    habitsRef = database.ref('users/' + userId + '/habits');
                    historyRef = database.ref('users/' + userId + '/history');
                    
                    // ë°ì´í„° ë¡œë“œ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹œì‘
                    setupFirebaseListeners();
                })
                .catch((error) => {
                    console.error("Firebase Auth Error:", error);
                });
        }

        // =========================================================================
        // 6. ì£¼ìš” ì•¡ì…˜ í•¨ìˆ˜ ìˆ˜ì • (Local Storage ëŒ€ì‹  Firebase ì €ì¥ í•¨ìˆ˜ í˜¸ì¶œ)
        // =========================================================================
        
        function renderHabits() { 
            const habitList = document.getElementById('habitList'); 
            habitList.innerHTML = '';
            
            const habitsToRender = habits; 
            const todayChecks = history[TODAY_KEY] || {};
            
            habitsToRender.forEach(habit => { 
                const isDue = isHabitDueToday(habit); 
                const isChecked = todayChecks[habit.id] || false; 
                const isNotDue = !isDue && habit.frequency !== 'weekly_count'; 
                
                const habitItem = document.createElement('div'); 
                habitItem.className = `habit-item ${isNotDue ? 'not-due' : ''}`; 
                habitItem.setAttribute('draggable', 'true');
                habitItem.setAttribute('data-id', habit.id);
                
                habitItem.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div class="checkbox ${isChecked ? 'checked' : ''}" 
                             onclick="event.stopPropagation(); toggleHabit(${habit.id})" 
                             ${isNotDue ? 'style="border-style: dashed;"' : ''}></div>
                    </div>
                    <div class="habit-editable-area" onclick="openEditHabitModal(${habit.id})">
                        <div class="habit-info">
                            <span class="habit-icon">${habit.icon || ''}</span>
                            <div class="habit-name-group">
                                <span class="habit-name">${habit.name}</span>
                                <span class="habit-frequency">${getFrequencyText(habit)}</span>
                            </div>
                        </div>
                    </div>
                    <button class="delete-btn" onclick="event.stopPropagation(); confirmDelete(${habit.id})" title="ì‚­ì œ">x</button>
                `; 
                
                habitItem.addEventListener('dragstart', handleDragStart);
                habitItem.addEventListener('dragover', handleDragOver);
                habitItem.addEventListener('drop', handleDrop);
                habitItem.addEventListener('dragenter', handleDragEnter);
                habitItem.addEventListener('dragleave', handleDragLeave);
                habitList.appendChild(habitItem); 
            });
            
            updateProgress(); 
            // âš ï¸ saveState() í˜¸ì¶œì€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.
        }

        let draggedHabitId = null;

        function handleDragStart(e) {
            draggedHabitId = parseInt(e.currentTarget.getAttribute('data-id'));
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedHabitId);
            setTimeout(() => e.currentTarget.classList.add('dragging'), 0);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const target = e.currentTarget;
            if (target.classList.contains('habit-item') && parseInt(target.getAttribute('data-id')) !== draggedHabitId) {
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                target.classList.add('drag-over');
            }
        }

        function handleDragEnter(e) {
            e.preventDefault();
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            const target = e.currentTarget;
            const targetId = parseInt(target.getAttribute('data-id'));
            
            document.querySelectorAll('.dragging, .drag-over').forEach(el => el.classList.remove('dragging', 'drag-over'));
            
            if (draggedHabitId === targetId) return;

            const sourceIndex = habits.findIndex(h => h.id === draggedHabitId);
            const targetIndex = habits.findIndex(h => h.id === targetId);

            if (sourceIndex > -1 && targetIndex > -1) {
                const [movedHabit] = habits.splice(sourceIndex, 1);
                habits.splice(targetIndex, 0, movedHabit);
                
                // ğŸ’¡ ìˆ˜ì •: Firebaseì— ì €ì¥ ìš”ì²­
                saveHabitsToFirebase(); 
                // renderHabits()ëŠ” ë¦¬ìŠ¤ë„ˆê°€ í˜¸ì¶œí•©ë‹ˆë‹¤.
            }
            draggedHabitId = null;
        }

        function toggleHabit(id) { 
            const habit = habits.find(h => h.id === id);
            if (!habit) return; 
            if (habit.frequency === 'weekly_days' && !isHabitDueToday(habit)) return; 
            const isChecked = !(history[TODAY_KEY] && history[TODAY_KEY][id]); 
            history[TODAY_KEY] = history[TODAY_KEY] || {}; 
            history[TODAY_KEY][id] = isChecked; 
            
            // ğŸ’¡ ìˆ˜ì •: Firebaseì— ê¸°ë¡ ì €ì¥ ìš”ì²­
            saveHistoryToFirebase(); 
            // renderHabits()ëŠ” ë¦¬ìŠ¤ë„ˆê°€ í˜¸ì¶œí•©ë‹ˆë‹¤.
        }

        function updateProgress() { 
            const dailyDueHabits = habits.filter(h => h.frequency === 'daily' || (h.frequency === 'weekly_days' && isHabitDueToday(h)));
            const totalDueItems = dailyDueHabits.length; 
            if (totalDueItems === 0) { 
                document.getElementById('progressText').textContent = 'ìŠµê´€ì„ ì¶”ê°€í•˜ì—¬ ì˜¤ëŠ˜ ëª©í‘œë¥¼ ì„¤ì •í•´ë³´ì„¸ìš”.'; 
                document.getElementById('progressBar').style.width = '0%'; 
                return;
            } 
            const todayChecks = history[TODAY_KEY] || {}; 
            const checkedItems = dailyDueHabits.filter(h => todayChecks[h.id]).length; 
            let percentage = totalDueItems > 0 ? Math.round((checkedItems / totalDueItems) * 100) : 0; 
            setTimeout(() => { 
                document.getElementById('progressBar').style.width = percentage + '%'; 
            }, 0);
            document.getElementById('progressText').textContent = `ì˜¤ëŠ˜ ë‹¬ì„±ë¥ : ${percentage}% (${checkedItems}/${totalDueItems})`; 
        }

        let selectedDays = [];
        function toggleFrequencyOptions() { 
            const frequency = document.querySelector('#habitFormModal #frequencySelect').value; 
            const daySelector = document.querySelector('#habitFormModal #daySelector'); 
            const countSelector = document.querySelector('#habitFormModal #countSelector');
            daySelector.style.display = 'none'; 
            countSelector.style.display = 'none'; 
            if (frequency === 'weekly_days') daySelector.style.display = 'flex';
            else if (frequency === 'weekly_count') countSelector.style.display = 'flex'; 
        }
        function setupDaySelector(initialDays) { 
            initialDays = initialDays || []; 
            const daySelector = document.querySelector('#habitFormModal #daySelector'); 
            if (!daySelector) return; 
            selectedDays = initialDays.slice();
            daySelector.querySelectorAll('button').forEach(button => { 
                const day = parseInt(button.getAttribute('data-day')); 
                button.classList.remove('selected'); 
                if (selectedDays.includes(day)) button.classList.add('selected'); 
                button.onclick = function() { 
                    const index = selectedDays.indexOf(day); 
                    if (index > -1) { 
                        selectedDays.splice(index, 1); 
                        this.classList.remove('selected'); 
                    } else { 
                        selectedDays.push(day); 
                        this.classList.add('selected'); 
                    } 
                }; 
            });
        }
        function openEditHabitModal(id) { 
            const habit = habits.find(h => h.id === id);
            if (!habit) return; 
            currentHabitId = id; 
            document.getElementById('habitFormTitle').textContent = 'ìŠµê´€ í¸ì§‘'; 
            document.getElementById('habitNameInput').value = habit.name; 
            document.getElementById('frequencySelect').value = habit.frequency; 
            document.getElementById('weeklyCountInput').value = habit.count || 1; 
            setupDaySelector(habit.days); 
            toggleFrequencyOptions(); 
            document.getElementById('habitFormModal').classList.add('open'); 
        }
        function openAddHabitModal() { 
            currentHabitId = null;
            document.getElementById('habitFormTitle').textContent = 'ìƒˆ ìŠµê´€ ì¶”ê°€'; 
            document.getElementById('habitNameInput').value = ''; 
            document.getElementById('frequencySelect').value = 'daily'; 
            document.getElementById('weeklyCountInput').value = 3; 
            setupDaySelector([]); 
            toggleFrequencyOptions(); 
            document.getElementById('habitFormModal').classList.add('open');
        }
        function closeHabitFormModal() { 
            document.getElementById('habitFormModal').classList.remove('open'); 
            currentHabitId = null;
        }
        function saveHabit() { 
            const name = document.getElementById('habitNameInput').value.trim(); 
            const frequency = document.getElementById('frequencySelect').value;
            const weeklyCountInput = document.getElementById('weeklyCountInput'); 
            if (!name) { 
                alert('ìŠµê´€ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); 
                return; 
            } 
            let days = []; 
            let count = 0;
            if (frequency === 'weekly_days') { 
                if (selectedDays.length === 0) { 
                    alert('ì£¼ê°„ íŠ¹ì • ìš”ì¼ ìŠµê´€ì€ ìš”ì¼ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
                    return; 
                } 
                days = selectedDays.slice(); 
            } else if (frequency === 'weekly_count') { 
                count = parseInt(weeklyCountInput.value);
                if (isNaN(count) || count < 1 || count > 7) { 
                    alert('ì£¼ê°„ íšŸìˆ˜ëŠ” 1íšŒë¶€í„° 7íšŒ ì‚¬ì´ë¡œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.'); 
                    return;
                } 
            } 
            if (currentHabitId !== null) { 
                const habitIndex = habits.findIndex(h => h.id === currentHabitId);
                if (habitIndex > -1) { 
                    habits[habitIndex] = { 
                        ...habits[habitIndex], 
                        name: name, 
                        frequency: frequency, 
                        days: days, 
                        count: count 
                    };
                } 
            } else { 
                const newHabit = { 
                    id: nextId++, 
                    icon: '', 
                    name: name, 
                    frequency: frequency, 
                    days: days, 
                    count: count 
                };
                habits.push(newHabit); 
            } 
            closeHabitFormModal(); 
            
            // ğŸ’¡ ìˆ˜ì •: Firebaseì— ìŠµê´€ ë°°ì—´ ì €ì¥ ìš”ì²­
            saveHabitsToFirebase();
            // renderHabits()ëŠ” ë¦¬ìŠ¤ë„ˆê°€ í˜¸ì¶œí•©ë‹ˆë‹¤.
        }
        function confirmDelete(id) { 
            openConfirmModal('ì •ë§ë¡œ ì´ ìŠµê´€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ë¡ë„ ì‚­ì œë©ë‹ˆë‹¤.', () => { 
                habits = habits.filter(h => h.id !== id); 
                for (const date in history) { 
                    if (history[date][id] !== undefined) { 
                        delete history[date][id]; 
                    } 
                } 
                // ğŸ’¡ ìˆ˜ì •: Firebaseì— ìŠµê´€ê³¼ ê¸°ë¡ ë™ì‹œ ì €ì¥ ìš”ì²­
                saveHabitsToFirebase(); 
                saveHistoryToFirebase();
                // renderHabits()ëŠ” ë¦¬ìŠ¤ë„ˆê°€ í˜¸ì¶œí•©ë‹ˆë‹¤.
            });
        }
        let pendingAction = null;
        function openConfirmModal(message, actionCallback) { 
            document.getElementById('confirmMessage').textContent = message.replace(/<br>/g, '');
            document.getElementById('confirmModal').style.display = 'block'; 
            pendingAction = actionCallback; 
            document.getElementById('confirmYesBtn').onclick = () => { 
                pendingAction(); 
                closeConfirmModal(); 
            };
        }
        function closeConfirmModal() { 
            document.getElementById('confirmModal').style.display = 'none'; 
            pendingAction = null;
        }
        function alert(message) { 
            window.alert(message);
        }
        
        // =========================================================================
        // 7. window.onload ìˆ˜ì • (ì•± ì‹œì‘ ì§€ì )
        // =========================================================================
        window.onload = function() { 
            document.getElementById('todayDateHeader').textContent = `ì˜¤ëŠ˜: ${TODAY_KEY}`; 
            const colorPicker = document.querySelector('#colorPicker');
            // âš ï¸ Local Storage ì œê±°: ê¸°ë³¸ ìƒ‰ìƒ ê°’ë§Œ ì‚¬ìš©
            const savedColor = colorPicker.value; 
            colorPicker.value = savedColor; 
            changeAccentColor(savedColor); 
            colorPicker.addEventListener('input', (e) => { 
                changeAccentColor(e.target.value); 
            });
            colorPicker.addEventListener('change', (e) => { 
                changeAccentColor(e.target.value); 
            }); 
            // ğŸ’¡ ìˆ˜ì •: renderHabits() ëŒ€ì‹  Firebase ì¸ì¦ ë° ë¡œë“œ ì‹œì‘
            initFirebaseApp();
        };
    </script>
</body>
</html>
